<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lịch, Nhà Hồ Thắng</title>

  <!-- Preconnect to required origins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FullCalendar (Defer loading to not block rendering) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" media="print" onload="this.media='all'"/>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js" defer></script>

  <!-- Fonts & Icons (Load asynchronously) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" media="print" onload="this.media='all'"/>

  <style>
    :root {
      --bg-primary: #f9fafb; --bg-secondary: #ffffff; --bg-tertiary: #f3f4f6;
      --text-primary: #111827; --text-secondary: #6b7280; --border-color: #d1d5db;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    [data-theme="dark"] {
      --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151;
      --text-primary: #f9fafb; --text-secondary: #9ca3af; --border-color: #4b5563;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
    }
    /*
      OPTIMIZATION: Removed the global transition (*) selector.
      Transitions are now applied only to specific classes like .btn-hover, .day-card, etc.
      This significantly improves rendering performance by not applying transitions to every element.
    */
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: var(--bg-primary); color: var(--text-primary);
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .app-bg { background-color: var(--bg-primary); }
    .card-bg { background-color: var(--bg-secondary); }
    .surface-bg { background-color: var(--bg-tertiary); }
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .border-custom { border-color: var(--border-color); }
    .shadow-custom { box-shadow: var(--shadow); }
    .shadow-lg-custom { box-shadow: var(--shadow-lg); }
    .day-card { 
      border-radius: 16px; min-height: 160px; 
      transition: transform .15s ease, box-shadow .15s ease, background-color 0.2s ease; 
      padding: 1rem;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      contain: layout style; /* Performance optimization */
      will-change: transform; /* Performance optimization */
    }
    .day-card.drag-over { 
      box-shadow: 0 0 0 4px rgba(91,33,182,0.25); transform: scale(1.02); 
    }
    .task-item { 
      border-radius: 12px; padding: 0.5rem; margin-top: .5rem; 
      color: #1f2937; cursor: grab; user-select: none; font-weight: 500;
      transition: all 0.2s ease; position: relative;
      contain: layout style; /* Performance optimization */
      will-change: transform; /* Performance optimization */
    }
    .task-item:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
    .task-item.dragging { opacity: .6; transform: rotate(5deg); z-index: 1000; }
    .task-item .drag-handle {
      position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
      opacity: 0; transition: opacity 0.2s ease; cursor: grab; color: rgba(255,255,255,0.7);
      font-size: 12px;
    }
    .task-item:hover .drag-handle { opacity: 1; }
    .task-container { min-height: 20px; }
    .task-container.drag-over-container { background-color: rgba(91,33,182,0.1); border-radius: 8px; }
    #sidebar { 
      z-index: 60; right: 0; top: 0;
      background-color: var(--bg-secondary);
      box-shadow: var(--shadow-lg);
      border-left: 1px solid var(--border-color);
      transition: transform 0.3s ease-in-out;
    }
    #current-week-display { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .modal-bg {
      background-color: var(--bg-secondary); box-shadow: var(--shadow-lg);
      transition: background-color 0.2s ease;
    }
    .input-custom {
      background-color: var(--bg-secondary); border-color: var(--border-color);
      color: var(--text-primary); transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    .input-custom:focus { outline: none; ring: 2px; ring-color: #8b5cf6; }
    .btn-hover { transition: filter 0.2s ease, background-color 0.2s ease; }
    .btn-hover:hover { filter: brightness(0.9); }
    .spinner {
      border: 2px solid var(--border-color); border-top: 2px solid #8b5cf6;
      border-radius: 50%; width: 20px; height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Day colors */
    .day-pink { background-color: #fce7f3; } .day-purple { background-color: #f3e8ff; }
    .day-blue { background-color: #dbeafe; } .day-green { background-color: #dcfce7; }
    .day-yellow { background-color: #fef3c7; } .day-stone { background-color: #f5f5f4; }
    .day-gray { background-color: #f3f4f6; }
    [data-theme="dark"] .day-pink { background-color: #4c1d95; } [data-theme="dark"] .day-purple { background-color: #581c87; }
    [data-theme="dark"] .day-blue { background-color: #1e3a8a; } [data-theme="dark"] .day-green { background-color: #14532d; }
    [data-theme="dark"] .day-yellow { background-color: #92400e; } [data-theme="dark"] .day-stone { background-color: #44403c; }
    [data-theme="dark"] .day-gray { background-color: #374151; }
  </style>

  <script>
    // Theme detection placed early to prevent flash of wrong theme
    (function() {
      const savedTheme = localStorage.getItem('theme') || 
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', savedTheme);
    })();
  </script>
</head>
<body class="p-4 app-bg text-primary">

<div class="container mx-auto max-w-4xl">
  <!-- Header -->
  <header class="flex justify-between items-center py-2 px-4">
    <h1 class="text-xl sm:text-2xl font-bold text-primary">Nhà Hồ Thắng</h1>
    <div class="flex items-center gap-3">
      <div id="sync-indicator" class="flex items-center gap-2">
        <span id="sync-dot" class="inline-block w-3 h-3 rounded-full bg-gray-400 transition-colors"></span>
        <div id="loading-spinner" class="spinner hidden"></div>
      </div>
      <button id="menu-toggle" class="text-secondary p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- Navigation -->
  <div class="flex items-center p-2 gap-2">
    <button id="prev-week-btn" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm btn-hover">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="text-center flex-1 px-2">
      <h2 id="current-week-display" class="text-sm font-semibold text-primary"></h2>
      <div class="text-xs text-blue-500 mt-1 hidden sm:block">
        <button id="copy-last-week-btn-inline" class="underline hover:text-blue-700 transition-colors">Sao chép lịch từ tuần trước</button>
      </div>
    </div>
    <button id="next-week-btn" class="px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm btn-hover">
      <i class="fas fa-arrow-right"></i>
    </button>
  </div>

  <!-- Week view -->
  <div id="week-view" class="grid grid-cols-2 lg:grid-cols-3 gap-3 p-4">
    <!-- Day cards will be generated by JavaScript for cleaner code -->
  </div>

  <!-- Month view -->
  <div id="month-view" class="hidden p-4">
    <div id='calendar' class="card-bg rounded-lg"></div>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar" class="fixed top-0 right-0 w-72 h-full card-bg shadow-lg-custom border-custom transform translate-x-full duration-300 ease-in-out">
  <div class="p-4 space-y-4">
    <div class="flex justify-between items-center">
      <h3 class="font-semibold text-lg text-primary">Tùy chọn</h3>
      <button id="sidebar-close" class="text-secondary p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"><i class="fas fa-times"></i></button>
    </div>
    <button id="theme-toggle-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg btn-hover"><i id="theme-icon" class="fas fa-moon"></i><span id="theme-text">Chế độ tối</span></button>
    <button id="copy-last-week-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg btn-hover"><i class="fas fa-copy"></i><span>Sao chép tuần trước</span></button>
    <button id="toggle-view-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg btn-hover"><i id="view-icon" class="fas fa-calendar"></i><span id="view-text">Chuyển xem tháng</span></button>
    <button id="delete-all-week-btn" class="w-full flex items-center gap-2 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg btn-hover"><i class="fas fa-trash-alt"></i><span>Xóa tất cả tuần này</span></button>
  </div>
</div>

<!-- Modal -->
<div id="task-modal" class="fixed inset-0 bg-gray-800 bg-opacity-40 flex items-center justify-center p-4 hidden z-50">
  <div class="modal-bg p-5 rounded-xl w-full max-w-sm shadow-lg-custom">
    <h2 id="modal-title" class="text-lg font-semibold mb-3 text-primary">Thêm môn học</h2>
    <input id="task-text" class="w-full border rounded p-2 mb-2 input-custom border-custom" placeholder="Nội dung môn / việc"/>
    <div class="flex gap-2 mb-2">
      <select id="task-day" class="flex-1 border rounded p-2 input-custom border-custom">
        <option value="T2">Thứ 2</option><option value="T3">Thứ 3</option><option value="T4">Thứ 4</option>
        <option value="T5">Thứ 5</option><option value="T6">Thứ 6</option><option value="T7">Thứ 7</option>
        <option value="CN">Chủ Nhật</option>
      </select>
      <input id="task-color" type="color" class="w-14 p-0 rounded border border-custom" value="#e85499"/>
    </div>
    <input id="task-date" type="date" class="hidden"/>
    <div id="task-last-updated" class="text-xs text-secondary mb-2"></div>
    <div class="flex justify-end gap-2">
      <button id="delete-task-btn" onclick="deleteTask()" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded hidden btn-hover">Xóa</button>
      <button onclick="closeModal()" class="px-3 py-2 surface-bg hover:bg-gray-300 dark:hover:bg-gray-600 rounded text-primary transition-colors">Hủy</button>
      <button id="save-task-btn" onclick="saveTask()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded btn-hover">Lưu</button>
    </div>
  </div>
</div>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCY-2-5gQsrEwp8m3t-e4_XxtXlaoREwFI",
    authDomain: "lichnhathang-ff90e.firebaseapp.com",
    projectId: "lichnhathang-ff90e",
    storageBucket: "lichnhathang-ff90e.firebasestorage.app",
    messagingSenderId: "1088977667391",
    appId: "1:1088977667391:web:3cd57e93d3be5537a17f8a"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const appId = firebaseConfig.projectId;
  const tasksCollectionRef = collection(db, "artifacts", appId, "public", "data", "tasks");

  // --- Performance Utilities ---
  const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => { clearTimeout(timeout); func(...args); };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  };
  const throttle = (func, limit) => {
    let inThrottle;
    return function() {
      const args = arguments;
      const context = this;
      if (!inThrottle) {
        func.apply(context, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    }
  };

  // --- State ---
  let currentEditingTask = null;
  let currentDate = new Date();
  let unsubscribeWeek = null;
  let draggedElement = null;
  let calendarVisible = false;
  let calendarInstance = null;
  let currentTheme = localStorage.getItem('theme') || 'light';
  let tasksCache = new Map(); // Caches rendered task elements
  let localTasksByDay = {}; // Local cache of task data for the current view

  // --- Constants ---
  const dayMap = { 'T2':0,'T3':1,'T4':2,'T5':3,'T6':4,'T7':5,'CN':6 };
  const dayIndexToKey = ['T2','T3','T4','T5','T6','T7','CN'];
  const dayColors = {
    'T2': 'pink', 'T3': 'purple', 'T4': 'blue', 'T5': 'green',
    'T6': 'yellow', 'T7': 'stone', 'CN': 'gray'
  };

  // --- UI & Theme ---
  function updateTheme(theme) {
    currentTheme = theme;
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    document.getElementById('theme-icon').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    document.getElementById('theme-text').textContent = theme === 'dark' ? 'Chế độ sáng' : 'Chế độ tối';
    if (calendarVisible && calendarInstance) {
      setTimeout(() => calendarInstance.render(), 100);
    }
  }

  function setLoading(loading) {
    document.getElementById('loading-spinner').classList.toggle('hidden', !loading);
    if (loading) {
      document.getElementById('sync-dot').style.backgroundColor = '#f59e0b'; // Orange for loading
    }
  }

  // --- Date & Time ---
  function getWeekDateRange(date) {
    const start = new Date(date);
    const dayOfWeek = start.getDay();
    const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    start.setDate(date.getDate() - diff);
    start.setHours(0,0,0,0);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    end.setHours(23,59,59,999);
    return { start, end };
  }

  function formatDate(date) {
    return date.toISOString().split('T')[0];
  }

  function updateDateDisplay() {
    const { start, end } = getWeekDateRange(currentDate);
    const opt = { day: '2-digit', month: '2-digit' };
    document.getElementById('current-week-display').textContent = 
      `Tuần từ ${start.toLocaleDateString('vi-VN', opt)} đến ${end.toLocaleDateString('vi-VN', opt)}`;
  }

  // --- Task Rendering & DOM ---
  function createTaskElement(task) {
    const el = document.createElement('div');
    el.className = 'task-item p-2 mb-1 rounded transition-all hover:shadow-md';
    el.style.backgroundColor = task.color || '#e85499';
    el.textContent = task.text || '(không tên)';
    el.setAttribute('draggable', 'true');
    el.dataset.taskId = task.id;
    el.dataset.taskDay = task.day || '';

    const dragHandle = document.createElement('i');
    dragHandle.className = 'fas fa-grip-lines drag-handle';
    el.appendChild(dragHandle);

    setupTaskEventListeners(el, task);
    return el;
  }
  
  const renderTasks = throttle((tasksByDay) => {
    localTasksByDay = tasksByDay; // Update local cache
    Object.keys(dayColors).forEach(day => {
      const container = document.getElementById(`tasks-${day}`);
      if (!container) return;
      
      const fragment = document.createDocumentFragment();
      const tasks = tasksByDay[day] || [];
      
      tasks.sort((a, b) => (a.order || 0) - (b.order || 0) || (a.text || '').localeCompare(b.text || ''));
      
      tasks.forEach(task => {
        const cacheKey = `${task.id}-${task.updatedAt}-${task.order}`;
        let el;
        if (tasksCache.has(cacheKey)) {
          el = tasksCache.get(cacheKey).cloneNode(true);
          setupTaskEventListeners(el, task);
        } else {
          el = createTaskElement(task);
          tasksCache.set(cacheKey, el.cloneNode(true));
        }
        fragment.appendChild(el);
      });
      
      container.innerHTML = '';
      container.appendChild(fragment);
    });
  }, 50);

  // --- Event Listeners Setup ---
  function setupTaskEventListeners(el, task) {
    el.addEventListener('click', (e) => { 
      if (!e.target.classList.contains('drag-handle')) openEditTaskModal(task); 
    });
    
    el.addEventListener('dragstart', (e) => {
      draggedElement = e.target;
      e.dataTransfer.setData('text/plain', task.id);
      e.dataTransfer.effectAllowed = 'move';
      setTimeout(() => e.target.classList.add('dragging'), 0);
    });
    
    el.addEventListener('dragend', (e) => {
      e.target.classList.remove('dragging');
      draggedElement = null;
      document.querySelectorAll('.drag-over-container, .drag-over').forEach(el => 
        el.classList.remove('drag-over-container', 'drag-over'));
    });

    el.addEventListener('dragover', (e) => {
      e.preventDefault();
      const container = el.parentElement;
      if (draggedElement && draggedElement !== el && container.contains(draggedElement)) {
        const afterElement = getDragAfterElement(container, e.clientY);
        if (afterElement == null) container.appendChild(draggedElement);
        else container.insertBefore(draggedElement, afterElement);
      }
    });
  }

  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  function initDayCardDropHandlers() {
    const weekView = document.getElementById('week-view');
    Object.keys(dayColors).forEach(day => {
        const color = dayColors[day];
        const cardHTML = `
            <div id="${day}" class="day-card day-${color}">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-primary">${day}</h3>
                    <button onclick="openAddTaskModal('${day}')" class="text-xl hover:bg-${color}-200 dark:hover:bg-${color}-800 rounded px-2 transition-colors text-primary">+</button>
                </div>
                <div id="tasks-${day}" class="task-container"></div>
            </div>`;
        weekView.insertAdjacentHTML('beforeend', cardHTML);
    });

    document.querySelectorAll('.task-container').forEach(container => {
        const dayId = container.id.replace('tasks-', '');
        const card = container.closest('.day-card');
        
        const dragOverHandler = (e) => {
            e.preventDefault();
            if (draggedElement) {
                container.classList.add('drag-over-container');
                card.classList.add('drag-over');
            }
        };

        const dragLeaveHandler = () => {
            container.classList.remove('drag-over-container');
            card.classList.remove('drag-over');
        };

        const dropHandler = async (e) => {
            e.preventDefault();
            dragLeaveHandler();
            if (!draggedElement) return;

            const taskId = draggedElement.dataset.taskId;
            const originalDay = draggedElement.dataset.taskDay;
            const newDay = dayId;
            
            if (originalDay === newDay) {
                // Reorder within the same day
                const taskElements = container.querySelectorAll('.task-item');
                const batch = writeBatch(db);
                taskElements.forEach((el, index) => {
                    const ref = doc(db, "artifacts", appId, "public", "data", "tasks", el.dataset.taskId);
                    batch.update(ref, { order: index + 1 });
                });
                await batch.commit().catch(err => console.error("Reorder failed:", err));
            } else {
                // Move to a different day
                const { start } = getWeekDateRange(currentDate);
                const newDate = new Date(start);
                newDate.setDate(start.getDate() + dayMap[newDay]);
                
                // OPTIMIZATION: Get next order from local data instead of fetching
                const nextOrder = ((localTasksByDay[newDay] || []).length > 0) 
                    ? Math.max(...localTasksByDay[newDay].map(t => t.order || 0)) + 1 
                    : 1;

                setLoading(true);
                const ref = doc(db, "artifacts", appId, "public", "data", "tasks", taskId);
                await setDoc(ref, { 
                    day: newDay, 
                    date: formatDate(newDate), 
                    order: nextOrder,
                    updatedAt: new Date().toISOString() 
                }, { merge: true }).catch(err => console.error("Move task failed:", err))
                .finally(() => setLoading(false));
            }
        };

        container.addEventListener('dragover', dragOverHandler);
        container.addEventListener('dragleave', dragLeaveHandler);
        container.addEventListener('drop', dropHandler);
    });
  }

  // --- Firebase & Data ---
  function setupWeekListener() {
    if (unsubscribeWeek) unsubscribeWeek();
    updateDateDisplay();
    setLoading(true);
    
    const { start, end } = getWeekDateRange(currentDate);
    const q = query(tasksCollectionRef, where("date", ">=", formatDate(start)), where("date", "<=", formatDate(end)));
    
    unsubscribeWeek = onSnapshot(q, (snapshot) => {
      document.getElementById('sync-dot').style.backgroundColor = '#22c55e'; // Green for success
      const tasksByDay = Object.fromEntries(Object.keys(dayColors).map(day => [day, []]));
      
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        if (d.day && tasksByDay[d.day]) tasksByDay[d.day].push({ id: docSnap.id, ...d });
      });
      
      renderTasks(tasksByDay);
      if (calendarVisible) renderMonth(tasksByDay);
      setLoading(false);
    }, (err) => {
      console.error("Listener error:", err);
      document.getElementById('sync-dot').style.backgroundColor = '#ef4444'; // Red for error
      setLoading(false);
    });
  }
  
  // --- Modal & CRUD ---
  window.openAddTaskModal = (dayOrDate) => {
    currentEditingTask = null;
    const modal = document.getElementById('task-modal');
    modal.querySelector('#modal-title').textContent = 'Thêm môn học';
    modal.querySelector('#task-text').value = '';
    modal.querySelector('#delete-task-btn').classList.add('hidden');
    
    let targetDate = new Date();
    let targetDayKey = 'T2';

    if (typeof dayOrDate === 'string' && dayMap.hasOwnProperty(dayOrDate)) {
        targetDayKey = dayOrDate;
        const { start } = getWeekDateRange(currentDate);
        targetDate = new Date(start);
        targetDate.setDate(start.getDate() + dayMap[dayOrDate]);
    } else if (dayOrDate instanceof Date) {
        targetDate = dayOrDate;
        const weekDay = targetDate.getDay();
        targetDayKey = weekDay === 0 ? 'CN' : dayIndexToKey[weekDay - 1];
    }
    
    modal.querySelector('#task-day').value = targetDayKey;
    modal.querySelector('#task-date').value = formatDate(targetDate);
    modal.querySelector('#task-color').value = '#e85499';
    modal.querySelector('#task-last-updated').textContent = '';
    modal.classList.remove('hidden');
    setTimeout(() => modal.querySelector('#task-text').focus(), 50);
  };

  window.openEditTaskModal = (task) => {
    currentEditingTask = task;
    const modal = document.getElementById('task-modal');
    modal.querySelector('#modal-title').textContent = 'Sửa môn học';
    modal.querySelector('#task-text').value = task.text || '';
    modal.querySelector('#task-day').value = task.day || 'T2';
    modal.querySelector('#task-color').value = task.color || '#e85499';
    modal.querySelector('#task-date').value = task.date || '';
    modal.querySelector('#task-last-updated').textContent = task.updatedAt 
      ? `Sửa lần cuối: ${new Date(task.updatedAt).toLocaleString('vi-VN')}` : '';
    modal.querySelector('#delete-task-btn').classList.remove('hidden');
    modal.classList.remove('hidden');
    setTimeout(() => modal.querySelector('#task-text').focus(), 50);
  };

  window.closeModal = () => {
    document.getElementById('task-modal').classList.add('hidden');
    currentEditingTask = null;
  };
  
  window.saveTask = async () => {
    const text = document.getElementById('task-text').value.trim();
    if (!text) { alert('Vui lòng nhập nội dung!'); return; }
    
    const day = document.getElementById('task-day').value;
    const { start } = getWeekDateRange(currentDate);
    const d = new Date(start);
    d.setDate(start.getDate() + dayMap[day]);

    const payload = { 
      text, day, 
      color: document.getElementById('task-color').value, 
      date: formatDate(d), 
      updatedAt: new Date().toISOString()
    };

    setLoading(true);
    try {
      if (currentEditingTask) { // Editing existing task
        payload.order = currentEditingTask.order || 1;
        const ref = doc(db, "artifacts", appId, "public", "data", "tasks", currentEditingTask.id);
        await setDoc(ref, payload, { merge: true });
      } else { // Creating new task
        // OPTIMIZATION: Calculate next order from local data instead of querying Firestore.
        const tasksOnDay = localTasksByDay[day] || [];
        payload.order = tasksOnDay.length > 0 ? Math.max(...tasksOnDay.map(t => t.order || 0)) + 1 : 1;
        payload.createdAt = new Date().toISOString();
        await setDoc(doc(tasksCollectionRef), payload);
      }
      closeModal();
    } catch (err) {
      console.error("Save task error:", err);
      alert("Lỗi khi lưu!");
    } finally {
      setLoading(false);
    }
  };

  window.deleteTask = async () => {
    if (!currentEditingTask || !confirm('Bạn chắc chắn muốn xóa?')) return;
    setLoading(true);
    try {
      await deleteDoc(doc(db, "artifacts", appId, "public", "data", "tasks", currentEditingTask.id));
      closeModal();
    } catch (err) {
      console.error("Delete task error:", err);
      alert("Lỗi khi xóa!");
    } finally {
      setLoading(false);
    }
  };
  
  // --- App Initialization ---
  function init() {
    // Basic event listeners
    document.getElementById('prev-week-btn').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() - 7);
        setupWeekListener();
    });
    document.getElementById('next-week-btn').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() + 7);
        setupWeekListener();
    });
    document.getElementById('theme-toggle-btn').addEventListener('click', () => updateTheme(currentTheme === 'light' ? 'dark' : 'light'));
    document.getElementById('sidebar-close').addEventListener('click', () => document.getElementById('sidebar').classList.add('translate-x-full'));
    document.getElementById('menu-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.remove('translate-x-full'));
    document.getElementById('task-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });

    // Initial setup
    updateTheme(currentTheme);
    initDayCardDropHandlers();
    setupWeekListener();
    
    // BUG FIX & OPTIMIZATION: Preload data for the next week to warm up Firestore's cache
    // The original implementation had a bug. This is a safer way to preload.
    setTimeout(() => {
        const nextWeekDate = new Date();
        nextWeekDate.setDate(new Date().getDate() + 7);
        const { start, end } = getWeekDateRange(nextWeekDate);
        const q = query(tasksCollectionRef, where("date", ">=", formatDate(start)), where("date", "<=", formatDate(end)));
        getDocs(q).catch(err => console.log('Preload next week failed:', err));
    }, 2500);

    console.log('App initialized.');
  }

  // Run app
  document.addEventListener('DOMContentLoaded', init);

  window.addEventListener('beforeunload', () => {
    if (unsubscribeWeek) unsubscribeWeek();
    tasksCache.clear();
  });
</script>

</body>
</html>
